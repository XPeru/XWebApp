-- MySQL Script generated by MySQL Workbench
-- 04/02/16 20:03:28
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='TRADITIONAL,ALLOW_INVALID_DATES';

-- -----------------------------------------------------
-- Schema testdb
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema testdb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `testdb` DEFAULT CHARACTER SET utf8 ;
USE `testdb` ;

-- -----------------------------------------------------
-- Table `testdb`.`TIPO_USUARIO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`TIPO_USUARIO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`TIPO_USUARIO` (
  `ID_TIPO_USUARIO` INT NOT NULL AUTO_INCREMENT,
  `TIPO` VARCHAR(100) NOT NULL,
  PRIMARY KEY (`ID_TIPO_USUARIO`),
  UNIQUE INDEX `ID_TIPO_USUARIO_UNIQUE` (`ID_TIPO_USUARIO` ASC),
  UNIQUE INDEX `TIPO_UNIQUE` (`TIPO` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`USUARIO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`USUARIO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`USUARIO` (
  `ID_USUARIO` INT NOT NULL AUTO_INCREMENT,
  `NOMBRE` VARCHAR(45) NOT NULL,
  `APELLIDOS` VARCHAR(100) NOT NULL,
  `EMAIL` VARCHAR(100) NULL,
  `PASSWORD` VARCHAR(256) NOT NULL,
  `FOTO` VARCHAR(100) NULL,
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1,
  `CREATE_TIME` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `UPDATE_TIME` TIMESTAMP NULL,
  `FK_TIPO_USUARIO` INT NOT NULL,
  PRIMARY KEY (`ID_USUARIO`),
  UNIQUE INDEX `ID_USUARIO_UNIQUE` (`ID_USUARIO` ASC),
  INDEX `fk_USUARIO_TIPO_USUARIO1_idx` (`FK_TIPO_USUARIO` ASC),
  CONSTRAINT `fk_USUARIO_TIPO_USUARIO1`
    FOREIGN KEY (`FK_TIPO_USUARIO`)
    REFERENCES `testdb`.`TIPO_USUARIO` (`ID_TIPO_USUARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`ACCESO_USUARIO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`ACCESO_USUARIO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`ACCESO_USUARIO` (
  `ID_ACCESO_USUARIO` INT NOT NULL AUTO_INCREMENT,
  `DESCRIPCION` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`ID_ACCESO_USUARIO`),
  UNIQUE INDEX `DESCRIPCION_UNIQUE` (`DESCRIPCION` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`ASOC_TIPO_ACCESO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`ASOC_TIPO_ACCESO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`ASOC_TIPO_ACCESO` (
  `FK_TIPO_USUARIO` INT NOT NULL,
  `FK_ACCESO_USUARIO` INT NOT NULL,
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1,
  INDEX `fk_ASOC_TIPO_ACCESO_TIPO_USUARIO1_idx` (`FK_TIPO_USUARIO` ASC),
  INDEX `fk_ASOC_TIPO_ACCESO_ACCESO_USUARIO1_idx` (`FK_ACCESO_USUARIO` ASC),
  PRIMARY KEY (`FK_TIPO_USUARIO`, `FK_ACCESO_USUARIO`),
  CONSTRAINT `fk_ASOC_TIPO_ACCESO_TIPO_USUARIO1`
    FOREIGN KEY (`FK_TIPO_USUARIO`)
    REFERENCES `testdb`.`TIPO_USUARIO` (`ID_TIPO_USUARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_ASOC_TIPO_ACCESO_ACCESO_USUARIO1`
    FOREIGN KEY (`FK_ACCESO_USUARIO`)
    REFERENCES `testdb`.`ACCESO_USUARIO` (`ID_ACCESO_USUARIO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`GLOBAL`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`GLOBAL` ;

CREATE TABLE IF NOT EXISTS `testdb`.`GLOBAL` (
  `ID_GLOBAL` INT NOT NULL AUTO_INCREMENT,
  `NOMBRE` VARCHAR(200) NOT NULL,
  `RUC` VARCHAR(45) NOT NULL,
  `DIRECCION` VARCHAR(200) NULL,
  `EMAIL` VARCHAR(45) NULL,
  `TELEFONO` VARCHAR(20) NULL,
  `LOGO` VARCHAR(200) NULL,
  `IMPUESTO` DECIMAL(10,2) NULL,
  `MONEDA` VARCHAR(5) NULL,
  `NOMBRE_IMPUESTO` VARCHAR(45) NULL,
  PRIMARY KEY (`ID_GLOBAL`),
  UNIQUE INDEX `ID_EMPRESA_UNIQUE` (`ID_GLOBAL` ASC),
  UNIQUE INDEX `RUC_UNIQUE` (`RUC` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`TIPO_PERSONA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`TIPO_PERSONA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`TIPO_PERSONA` (
  `ID_TIPO_PERSONA` INT NOT NULL AUTO_INCREMENT,
  `DESCRIPCION` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`ID_TIPO_PERSONA`),
  UNIQUE INDEX `ID_TIPO_PERSONA_UNIQUE` (`ID_TIPO_PERSONA` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`PROVEEDOR_CLIENTE`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`PROVEEDOR_CLIENTE` ;

CREATE TABLE IF NOT EXISTS `testdb`.`PROVEEDOR_CLIENTE` (
  `ID_PROVEEDOR_CLIENTE` INT NOT NULL AUTO_INCREMENT,
  `NOMBRE` VARCHAR(45) NOT NULL,
  `EMAIL` VARCHAR(100) NOT NULL,
  `RUC` VARCHAR(45) NULL,
  `NUMERO_CUENTA` VARCHAR(45) NULL,
  `DIRECCION_CALLE` VARCHAR(45) NULL,
  `DIRECCION_DISTRITO` VARCHAR(45) NULL,
  `DIRECCION_DEPARTAMENTO` VARCHAR(45) NULL,
  `DIRECCION_COMPLEMENTO` VARCHAR(45) NULL,
  `TELEFONO` VARCHAR(12) NULL,
  `FK_TIPO_PERSONA` INT NOT NULL,
  PRIMARY KEY (`ID_PROVEEDOR_CLIENTE`),
  UNIQUE INDEX `ID_PROVEEDOR_CLIENTE_UNIQUE` (`ID_PROVEEDOR_CLIENTE` ASC),
  INDEX `fk_PROVEEDOR_CLIENTE_TIPO_PERSONA1_idx` (`FK_TIPO_PERSONA` ASC),
  CONSTRAINT `fk_PROVEEDOR_CLIENTE_TIPO_PERSONA1`
    FOREIGN KEY (`FK_TIPO_PERSONA`)
    REFERENCES `testdb`.`TIPO_PERSONA` (`ID_TIPO_PERSONA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`TIPO_DOCUMENTO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`TIPO_DOCUMENTO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`TIPO_DOCUMENTO` (
  `ID_TIPO_DOCUMENTO` INT NOT NULL AUTO_INCREMENT,
  `DESCRIPCION` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`ID_TIPO_DOCUMENTO`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`INGRESO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`INGRESO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`INGRESO` (
  `ID_INGRESO` INT NOT NULL AUTO_INCREMENT,
  `CODE_INGRESO` VARCHAR(45) NULL,
  `COSTO_TOTAL` DECIMAL(10,2) NOT NULL,
  `FK_CREATE_USUARIO` INT NOT NULL,
  `CREATE_TIME` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `FK_UPDATE_USUARIO` INT NULL,
  `UPDATE_TIME` TIMESTAMP NULL,
  `FK_PROVEEDOR` INT NOT NULL,
  `FK_TIPO_DOCUMENTO` INT NOT NULL,
  PRIMARY KEY (`ID_INGRESO`),
  UNIQUE INDEX `ID_INGRESO_UNIQUE` (`ID_INGRESO` ASC),
  INDEX `fk_INGRESO_PROVEEDOR_CLIENTE1_idx` (`FK_PROVEEDOR` ASC),
  INDEX `fk_INGRESO_TIPO_DOCUMENTO1_idx` (`FK_TIPO_DOCUMENTO` ASC),
  CONSTRAINT `fk_INGRESO_PROVEEDOR_CLIENTE1`
    FOREIGN KEY (`FK_PROVEEDOR`)
    REFERENCES `testdb`.`PROVEEDOR_CLIENTE` (`ID_PROVEEDOR_CLIENTE`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_INGRESO_TIPO_DOCUMENTO1`
    FOREIGN KEY (`FK_TIPO_DOCUMENTO`)
    REFERENCES `testdb`.`TIPO_DOCUMENTO` (`ID_TIPO_DOCUMENTO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`CATEGORIA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`CATEGORIA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`CATEGORIA` (
  `ID_CATEGORIA` INT NOT NULL AUTO_INCREMENT,
  `DESCRIPCION` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`ID_CATEGORIA`))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`ARTICULO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`ARTICULO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`ARTICULO` (
  `ID_ARTICULO` INT NOT NULL AUTO_INCREMENT COMMENT 'Secuencia de Artículo',
  `CODIGO` VARCHAR(20) NOT NULL COMMENT 'ID de Artículo',
  `DESCRIPCION` VARCHAR(45) NOT NULL COMMENT 'Descripción',
  `UNIDAD` VARCHAR(10) NOT NULL DEFAULT 'Unidad' COMMENT 'Medida de Cantidad',
  `PRECIO_UNITARIO` DECIMAL(10,2) NOT NULL COMMENT 'Precio por Unidad de medida',
  `IMAGEN` VARCHAR(100) NULL,
  `VALOR_REPOSICION` INT NULL COMMENT 'Valor de Reposición ',
  `FK_CATEGORIA` INT NOT NULL,
  PRIMARY KEY (`ID_ARTICULO`),
  UNIQUE INDEX `ID_ART_UNIQUE` (`CODIGO` ASC),
  INDEX `fk_ARTICULO_CATEGORIA1_idx` (`FK_CATEGORIA` ASC),
  CONSTRAINT `fk_ARTICULO_CATEGORIA1`
    FOREIGN KEY (`FK_CATEGORIA`)
    REFERENCES `testdb`.`CATEGORIA` (`ID_CATEGORIA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
COMMENT = 'Tabla de Artículos';


-- -----------------------------------------------------
-- Table `testdb`.`ALMACEN`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`ALMACEN` ;

CREATE TABLE IF NOT EXISTS `testdb`.`ALMACEN` (
  `ID_ALMACEN` INT NOT NULL AUTO_INCREMENT COMMENT 'Secuencia de Almacén',
  `CODIGO` VARCHAR(20) NOT NULL COMMENT 'ID de Almacén',
  `UBICACION` VARCHAR(100) NOT NULL,
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Flag de Actividad',
  PRIMARY KEY (`ID_ALMACEN`))
ENGINE = InnoDB
COMMENT = 'Tabla de Almacenes';


-- -----------------------------------------------------
-- Table `testdb`.`DETALLE_INGRESO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`DETALLE_INGRESO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`DETALLE_INGRESO` (
  `ID_DETALLE_INGRESO` INT NOT NULL AUTO_INCREMENT COMMENT 'Secuencia de Ingreso Detallado',
  `CANTIDAD` DECIMAL(10,2) NOT NULL COMMENT 'Cantidad',
  `PRECIO` DECIMAL(10,2) NOT NULL,
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Flag de Actividad',
  `FK_INGRESO` INT NOT NULL,
  `FK_ARTICULO` INT NOT NULL,
  `FK_ALMACEN` INT NOT NULL,
  PRIMARY KEY (`ID_DETALLE_INGRESO`),
  INDEX `fk_DETALLE_INGRESO_INGRESO1_idx` (`FK_INGRESO` ASC),
  INDEX `fk_DETALLE_INGRESO_ARTICULO1_idx` (`FK_ARTICULO` ASC),
  INDEX `fk_DETALLE_INGRESO_ALMACEN1_idx` (`FK_ALMACEN` ASC),
  CONSTRAINT `fk_DETALLE_INGRESO_INGRESO1`
    FOREIGN KEY (`FK_INGRESO`)
    REFERENCES `testdb`.`INGRESO` (`ID_INGRESO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_INGRESO_ARTICULO1`
    FOREIGN KEY (`FK_ARTICULO`)
    REFERENCES `testdb`.`ARTICULO` (`ID_ARTICULO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_INGRESO_ALMACEN1`
    FOREIGN KEY (`FK_ALMACEN`)
    REFERENCES `testdb`.`ALMACEN` (`ID_ALMACEN`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
COMMENT = 'Tabla de Detalles de Ingreso';


-- -----------------------------------------------------
-- Table `testdb`.`ESTADO`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`ESTADO` ;

CREATE TABLE IF NOT EXISTS `testdb`.`ESTADO` (
  `ID_ESTADO` INT NOT NULL AUTO_INCREMENT,
  `DESCRIPCION` VARCHAR(45) NOT NULL,
  PRIMARY KEY (`ID_ESTADO`),
  UNIQUE INDEX `ID_ESTADO_UNIQUE` (`ID_ESTADO` ASC),
  UNIQUE INDEX `DESCRIPCION_UNIQUE` (`DESCRIPCION` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`VENTA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`VENTA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`VENTA` (
  `ID_VENTA` INT NOT NULL AUTO_INCREMENT,
  `PRECIO_TOTAL` DECIMAL(10,2) UNSIGNED NOT NULL,
  `MONTO_PAGADO` DECIMAL(10,2) NULL,
  `FECHA_PEDIDO` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `FECHA_PROMESA` DATE NULL,
  `FECHA_ENTREGA` DATE NULL,
  `FK_ESTADO` INT NOT NULL,
  `FK_CLIENTE` INT NOT NULL,
  `FK_TIPO_DOCUMENTO` INT NOT NULL,
  PRIMARY KEY (`ID_VENTA`),
  UNIQUE INDEX `ID_VENTA_UNIQUE` (`ID_VENTA` ASC),
  INDEX `fk_VENTA_PROVEEDOR_CLIENTE1_idx` (`FK_CLIENTE` ASC),
  INDEX `fk_VENTA_TIPO_DOCUMENTO1_idx` (`FK_TIPO_DOCUMENTO` ASC),
  INDEX `fk_VENTA_ESTADO1_idx` (`FK_ESTADO` ASC),
  CONSTRAINT `fk_VENTAS_PROVEEDOR_CLIENTE1`
    FOREIGN KEY (`FK_CLIENTE`)
    REFERENCES `testdb`.`PROVEEDOR_CLIENTE` (`ID_PROVEEDOR_CLIENTE`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_VENTAS_TIPO_DOCUMENTO1`
    FOREIGN KEY (`FK_TIPO_DOCUMENTO`)
    REFERENCES `testdb`.`TIPO_DOCUMENTO` (`ID_TIPO_DOCUMENTO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_VENTA_ESTADO1`
    FOREIGN KEY (`FK_ESTADO`)
    REFERENCES `testdb`.`ESTADO` (`ID_ESTADO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`SALIDA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`SALIDA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`SALIDA` (
  `ID_SALIDA` INT NOT NULL AUTO_INCREMENT COMMENT '		',
  `CODE_SALIDA` VARCHAR(45) NULL,
  `COSTO_TOTAL` DECIMAL(10,2) NOT NULL,
  `FK_CREATE_USUARIO` INT NOT NULL,
  `CREATE_TIME` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `FK_UPDATE_USUARIO` INT NULL,
  `UPDATE_TIME` TIMESTAMP NULL,
  `FK_TIPO_DOCUMENTO` INT NOT NULL,
  `FK_VENTA` INT NOT NULL,
  PRIMARY KEY (`ID_SALIDA`),
  UNIQUE INDEX `ID_INGRESO_UNIQUE` (`ID_SALIDA` ASC),
  INDEX `fk_SALIDA_TIPO_DOCUMENTO1_idx` (`FK_TIPO_DOCUMENTO` ASC),
  INDEX `fk_SALIDA_VENTAS1_idx` (`FK_VENTA` ASC),
  CONSTRAINT `fk_SALIDA_TIPO_DOCUMENTO1`
    FOREIGN KEY (`FK_TIPO_DOCUMENTO`)
    REFERENCES `testdb`.`TIPO_DOCUMENTO` (`ID_TIPO_DOCUMENTO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_SALIDA_VENTAS1`
    FOREIGN KEY (`FK_VENTA`)
    REFERENCES `testdb`.`VENTA` (`ID_VENTA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`DETALLE_SALIDA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`DETALLE_SALIDA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`DETALLE_SALIDA` (
  `ID_DETALLE_SALIDA` INT NOT NULL AUTO_INCREMENT COMMENT 'Secuencia de Ingreso Detallado',
  `CANTIDAD` DECIMAL(10,2) NOT NULL COMMENT 'Cantidad',
  `PRECIO` DECIMAL(10,2) NOT NULL,
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Flag de Actividad',
  `FK_SALIDA` INT NOT NULL,
  `FK_ARTICULO` INT NOT NULL,
  `FK_ALMACEN` INT NOT NULL,
  PRIMARY KEY (`ID_DETALLE_SALIDA`),
  INDEX `fk_DETALLE_SALIDA_SALIDA1_idx` (`FK_SALIDA` ASC),
  INDEX `fk_DETALLE_SALIDA_ARTICULO1_idx` (`FK_ARTICULO` ASC),
  INDEX `fk_DETALLE_SALIDA_ALMACEN1_idx` (`FK_ALMACEN` ASC),
  CONSTRAINT `fk_DETALLE_SALIDA_SALIDA1`
    FOREIGN KEY (`FK_SALIDA`)
    REFERENCES `testdb`.`SALIDA` (`ID_SALIDA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_SALIDA_ARTICULO1`
    FOREIGN KEY (`FK_ARTICULO`)
    REFERENCES `testdb`.`ARTICULO` (`ID_ARTICULO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_SALIDA_ALMACEN1`
    FOREIGN KEY (`FK_ALMACEN`)
    REFERENCES `testdb`.`ALMACEN` (`ID_ALMACEN`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
COMMENT = 'Tabla de Detalles de Ingreso';


-- -----------------------------------------------------
-- Table `testdb`.`DETALLE_ALMACEN`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`DETALLE_ALMACEN` ;

CREATE TABLE IF NOT EXISTS `testdb`.`DETALLE_ALMACEN` (
  `ID_DETALLE_ALMACEN` INT NOT NULL AUTO_INCREMENT COMMENT 'Secuencia de Almacén Detallado',
  `CANTIDAD` DECIMAL(10,2) NOT NULL COMMENT 'Cantidad',
  `IS_ACTIVE` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Flag de Actividad',
  `FK_ALMACEN` INT NOT NULL,
  `FK_ARTICULO` INT NOT NULL,
  PRIMARY KEY (`ID_DETALLE_ALMACEN`),
  INDEX `fk_DETALLE_ALMACEN_ALMACEN1_idx` (`FK_ALMACEN` ASC),
  INDEX `fk_DETALLE_ALMACEN_ARTICULO1_idx` (`FK_ARTICULO` ASC),
  CONSTRAINT `fk_DETALLE_ALMACEN_ALMACEN1`
    FOREIGN KEY (`FK_ALMACEN`)
    REFERENCES `testdb`.`ALMACEN` (`ID_ALMACEN`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_ALMACEN_ARTICULO1`
    FOREIGN KEY (`FK_ARTICULO`)
    REFERENCES `testdb`.`ARTICULO` (`ID_ARTICULO`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB
COMMENT = 'Tabla de Detalles de Almacén';


-- -----------------------------------------------------
-- Table `testdb`.`TRANSFORMADOR`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`TRANSFORMADOR` ;

CREATE TABLE IF NOT EXISTS `testdb`.`TRANSFORMADOR` (
  `ID_TRANSFORMADOR` INT NOT NULL AUTO_INCREMENT,
  `NOMBRE` VARCHAR(45) NULL,
  `POTENCIA` VARCHAR(45) NULL,
  `VOLTAJE` VARCHAR(45) NULL,
  `AMPERAJE` VARCHAR(45) NULL,
  PRIMARY KEY (`ID_TRANSFORMADOR`),
  UNIQUE INDEX `ID_TRANSFORMADOR_UNIQUE` (`ID_TRANSFORMADOR` ASC))
ENGINE = InnoDB;


-- -----------------------------------------------------
-- Table `testdb`.`DETALLE_VENTA`
-- -----------------------------------------------------
DROP TABLE IF EXISTS `testdb`.`DETALLE_VENTA` ;

CREATE TABLE IF NOT EXISTS `testdb`.`DETALLE_VENTA` (
  `ID_DETALLE_VENTA` INT NOT NULL AUTO_INCREMENT,
  `PRECIO_VENTA` DECIMAL(10,2) NOT NULL,
  `FK_TRANSFORMADOR` INT NOT NULL,
  `FK_VENTA` INT NOT NULL,
  PRIMARY KEY (`ID_DETALLE_VENTA`),
  UNIQUE INDEX `ID_DETALLE_VENTA_UNIQUE` (`ID_DETALLE_VENTA` ASC),
  INDEX `fk_DETALLE_VENTA_TRANSFORMADOR1_idx` (`FK_TRANSFORMADOR` ASC),
  INDEX `fk_DETALLE_VENTA_VENTA1_idx` (`FK_VENTA` ASC),
  CONSTRAINT `fk_DETALLE_VENTA_TRANSFORMADOR1`
    FOREIGN KEY (`FK_TRANSFORMADOR`)
    REFERENCES `testdb`.`TRANSFORMADOR` (`ID_TRANSFORMADOR`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_DETALLE_VENTA_VENTA1`
    FOREIGN KEY (`FK_VENTA`)
    REFERENCES `testdb`.`VENTA` (`ID_VENTA`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

START TRANSACTION;
ALTER TABLE INGRESO ADD FECHA_INGRESO DATE AFTER COSTO_TOTAL;
COMMIT;

START TRANSACTION;
ALTER TABLE SALIDA ADD FECHA_SALIDA DATE AFTER COSTO_TOTAL;
COMMIT;

USE testdb;
DROP PROCEDURE IF EXISTS `SP_SEARCH_ALL`;
USE testdb;
DROP PROCEDURE IF EXISTS `SP_SEARCH`;
USE testdb;
DROP PROCEDURE IF EXISTS `SP_SEARCH_STRING`;
DELIMITER $$
USE testdb$$
CREATE PROCEDURE `SP_SEARCH_ALL` (IN tab_name varchar(100))
BEGIN
	SET @query = CONCAT ('SELECT * FROM ',tab_name);
    PREPARE stmt FROM @query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

DELIMITER $$
USE testdb$$
CREATE PROCEDURE `SP_SEARCH` (IN tab_name varchar(100), IN col_name varchar(50), IN col_value varchar(50))
BEGIN
	SET @query = CONCAT ('SELECT * FROM ',tab_name,' WHERE ',col_name,' = ',col_value);
    PREPARE stmt FROM @query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

DELIMITER $$
USE testdb$$
CREATE PROCEDURE `SP_SEARCH_STRING` (IN tab_name varchar(100), IN col_name varchar(50), IN col_value varchar(50))
BEGIN
	SET @query = CONCAT ('SELECT * FROM ',tab_name,' WHERE ',col_name,' = "',col_value,'"');
    PREPARE stmt FROM @query;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END$$
DELIMITER ;

ALTER TABLE `ARTICULO` CHANGE COLUMN `CODIGO` `CODIGO_ARTICULO` VARCHAR(20) NOT NULL;
ALTER TABLE `ALMACEN` CHANGE COLUMN `CODIGO` `CODIGO_ALMACEN` VARCHAR(20) NOT NULL;

ALTER TABLE `testdb`.`INGRESO`
CHANGE COLUMN `COSTO_TOTAL` `COSTO_TOTAL` DECIMAL(10,2) NOT NULL DEFAULT 0 ;

USE testdb;
DROP PROCEDURE IF EXISTS SP_PROCESS_MVMT;

DELIMITER $$
CREATE PROCEDURE SP_PROCESS_MVMT (IN process_type varchar(5), IN mvmt_type varchar(20), IN mvmt_id int(11))
BEGIN
    DECLARE `_rollback` BOOL DEFAULT 0;
    DECLARE `_done` INT DEFAULT FALSE;
    DECLARE cursor_ID_ALM INT;
    DECLARE cursor_ID_ART INT;
    DECLARE cursor_VAL INT;
    DECLARE cursor_i CURSOR FOR SELECT * FROM temporal;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET `_done` = TRUE;

    SET @table = mvmt_type;
    SET @id_table = CONCAT('ID_',@table);
    SET @table_detail = CONCAT('DETALLE_',@table);
    SET @fk_id_table = CONCAT('FK_',@table);
    SET @tmp_str = CONCAT('CREATE TEMPORARY TABLE temporal AS ', 'SELECT TD.FK_ALMACEN AS ID_ALM, TD.FK_ARTICULO AS ID_ART, TD.CANTIDAD AS VAL FROM ',@table,' T, ',@table_detail,' TD WHERE T.',@id_table,' = TD.',@fk_id_table,' AND T.',@id_table,' = ',mvmt_id);
    PREPARE tmp_stmt FROM @tmp_str;
    DROP TEMPORARY TABLE IF EXISTS temporal;
    EXECUTE tmp_stmt;
    DEALLOCATE PREPARE tmp_stmt;

    START TRANSACTION;
    OPEN cursor_i;
    SET @ins_str = 'INSERT INTO DETALLE_ALMACEN (CANTIDAD,IS_ACTIVE,FK_ALMACEN,FK_ARTICULO) VALUES (?,1,?,?) ON DUPLICATE KEY UPDATE CANTIDAD = CANTIDAD + ?';
    PREPARE ins_stmt FROM @ins_str;
    read_loop: LOOP
        FETCH cursor_i INTO cursor_ID_ALM, cursor_ID_ART, cursor_VAL;
        IF ((process_type = 'DEL'  AND mvmt_type = 'INGRESO') OR (process_type = 'ADD' AND mvmt_type = 'SALIDA')) THEN
            SET @a = -cursor_VAL;
        ELSE SET @a = cursor_VAL;
        END IF;
        SET @b = cursor_ID_ALM;
        SET @c = cursor_ID_ART;
        IF `_done` THEN
            LEAVE read_loop;
        END IF;
        EXECUTE ins_stmt USING @a, @b, @c, @a;
    END LOOP;
    CLOSE cursor_i;
    DEALLOCATE PREPARE ins_stmt;
    IF `_rollback` THEN
        ROLLBACK;
    ELSE
        COMMIT;
    END IF;
END$$
DELIMITER ;

USE testdb;
DROP PROCEDURE IF EXISTS SP_DELETE_DETALLE;

DELIMITER $$
CREATE PROCEDURE SP_DELETE_DETALLE (IN mvmt_type varchar(31), IN mvmt_id int(11))
BEGIN
    DECLARE `_rollback` BOOL DEFAULT 0;
    DECLARE done INT DEFAULT FALSE;

	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

	SET @id = mvmt_id;
    SET @mvmt_type = mvmt_type;
	SET @v = CONCAT('DELETE FROM DETALLE_', @mvmt_type, ' WHERE FK_', @mvmt_type, '=', @id);
	PREPARE stmt FROM @v;
    CALL SP_PROCESS_MVMT('DEL', @mvmt_type, @id);
    -- AQUI GESTIONAR EL ERROR EN LA LLAMADA A SP
    START TRANSACTION;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    IF `_rollback` THEN
        ROLLBACK;
    ELSE
        COMMIT;
    END IF;
END$$
DELIMITER ;

USE testdb;
DROP PROCEDURE IF EXISTS SP_INSERT_DETALLE;

DELIMITER $$
CREATE PROCEDURE SP_INSERT_DETALLE (IN query varchar(8000), IN mvmt_type varchar(31), IN mvmt_id int(11))
BEGIN
    DECLARE `_rollback` BOOL DEFAULT 0;
    DECLARE done INT DEFAULT FALSE;

	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
	SET @v = query;
	PREPARE stmt FROM @v;
    START TRANSACTION;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;

    CALL SP_PROCESS_MVMT('ADD', mvmt_type, mvmt_id);
    IF `_rollback` THEN
        ROLLBACK;
    ELSE
        COMMIT;
    END IF;
END$$
DELIMITER ;

ALTER TABLE `testdb`.`DETALLE_ALMACEN`
ADD UNIQUE INDEX `UQ_ALMACEN_ARTICULO` (`FK_ALMACEN` ASC, `FK_ARTICULO` ASC);


ALTER TABLE `testdb`.`DETALLE_INGRESO`
ADD UNIQUE INDEX `UQ_ING_ALM_ART` (`FK_INGRESO` ASC, `FK_ALMACEN` ASC, `FK_ARTICULO` ASC);

ALTER TABLE `testdb`.`DETALLE_SALIDA`
ADD UNIQUE INDEX `UQ_SLD_ALM_ART` (`FK_SALIDA` ASC, `FK_ALMACEN` ASC, `FK_ARTICULO` ASC);
